<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matbench-Speed</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; transition: background 0.3s, color 0.3s; }
        body.dark { background: #111; color: #eee; }
        body.light { background: #f5f5f5; color: #222; }
        h1 { font-size: 1.4em; margin-bottom: 16px; }
        body.dark h1 { color: #fff; }
        body.light h1 { color: #000; }
        .controls { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; align-items: flex-end; }
        .control { display: flex; flex-direction: column; gap: 4px; }
        .control label { font-size: 12px; }
        body.dark .control label { color: #aaa; }
        body.light .control label { color: #666; }
        .control select { padding: 6px 10px; font-size: 14px; border-radius: 4px; }
        body.dark .control select { border: 1px solid #444; background: #222; color: #eee; }
        body.light .control select { border: 1px solid #ccc; background: #fff; color: #222; }
        button { padding: 6px 12px; font-size: 13px; border-radius: 4px; cursor: pointer; }
        body.dark button { border: 1px solid #444; background: #222; color: #eee; }
        body.dark button:hover { background: #333; }
        body.light button { border: 1px solid #ccc; background: #fff; color: #222; }
        body.light button:hover { background: #e5e5e5; }
        .chart-container { position: relative; height: 500px; border-radius: 8px; padding: 10px; transition: background 0.3s; }
        body.dark .chart-container { background: #1a1a1a; }
        body.light .chart-container { background: #fff; border: 1px solid #ddd; }
        canvas { max-width: 100%; }
        .theme-toggle { display: flex; align-items: center; gap: 6px; margin-left: auto; }
        .theme-toggle span { font-size: 12px; }
        .switch { position: relative; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: 0.3s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
        input:checked + .slider { background-color: #888; }
        input:checked + .slider:before { transform: translateX(20px); }
        .hint { transition: color 0.3s; }
        body.dark .hint { color: #888; }
        body.light .hint { color: #666; }
    </style>
</head>
<body class="dark">
    <h1>Matbench-Speed Benchmark Results</h1>
    <div class="controls">
        <div class="control">
            <label>GPU</label>
            <select id="gpu"></select>
        </div>
        <div class="control">
            <label>Compliance</label>
            <select id="compliance">
                <option value="compliant">Compliant</option>
                <option value="non-compliant" selected>Non-compliant</option>
            </select>
        </div>
        <div class="control">
            <label>System</label>
            <select id="system"></select>
        </div>
        <div class="control">
            <label>Y-axis</label>
            <select id="yaxis">
                <option value="ms_step">Speed - ms/step</option>
                <option value="steps_sec">Throughput - steps/s</option>
                <option value="steps_million">Throughput - million steps/day</option>
                <option value="ns_0.5">Throughput - ns/day, 0.5 fs timestep</option>
                <option value="ns_1" selected>Throughput - ns/day, 1 fs timestep</option>
                <option value="ns_2">Throughput - ns/day, 2 fs timestep</option>
                <option value="ns_4">Throughput - ns/day, 4 fs timestep</option>
            </select>
        </div>
        <button onclick="resetZoom()">Reset Zoom</button>
        <div class="theme-toggle">
            <span>Dark</span>
            <label class="switch">
                <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
                <span class="slider"></span>
            </label>
            <span>Light</span>
        </div>
    </div>
    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>
    <p class="hint" style="font-size:11px;margin-top:8px;">Scroll to zoom, drag to pan, or drag-select an area to zoom in</p>

    <script>
    // File naming: timing_data_{GPU}_{element}_{lattice}.csv
    // e.g., timing_data_H100_Si_5.43.csv -> GPU=H100, element=Si, lattice=5.43

    // Auto-detect repo from GitHub Pages URL, or set manually for local dev
    function getRepoInfo() {
        const host = window.location.hostname;
        if (host.endsWith('.github.io')) {
            const owner = host.replace('.github.io', '');
            const repo = window.location.pathname.split('/')[1] || 'matbench-speed';
            return { owner, repo };
        }
        // Default for local testing
        return { owner: 'mitkotak', repo: 'matbench-speed' };
    }

    const COMPLIANT_MODELS = [
        'Nequix-MP-1.5', 'Nequix-MP-1', 'eSEN-30M-MP', 'MACE-MP-0', 'MACE-MP-0-kernel',
        'NequIP-MP-L', 'SevenNet-l3i5', 'GRACE-2L-MPtrj'
    ];
    const NON_COMPLIANT_MODELS = [
        'PET-OAM-XL', 'PET-MAD-S', 'NequIP-MP-XL', 'Orb-v3-cons-inf-omat', 'eSEN-6M-OC25'
    ];

    const MODEL_COLORS = {
        'Nequix-MP-1.5': '#22bbff',
        'Nequix-MP-1': '#3366ff',
        'eSEN-30M-MP': '#ff9933',
        'MACE-MP-0': '#dd44dd',
        'MACE-MP-0-kernel': '#dd44dd',
        'NequIP-MP-L': '#33cc33',
        'SevenNet-l3i5': '#ee3333',
        'GRACE-2L-MPtrj': '#888888',
        'PET-MAD-S': '#ff6644',
        'PET-OAM-XL': '#44aacc',
        'NequIP-MP-XL': '#ee77aa',
        'eSEN-6M-OC25': '#aa44dd',
        'Orb-v3-cons-inf-omat': '#ddaa22'
    };

    let chart = null;
    let dataCache = {};
    let availableFiles = []; // [{gpu, element, lattice, filename}]

    function parseFilename(filename) {
        // timing_data_{GPU}_{element}_{lattice}.csv
        const match = filename.match(/^timing_data_([^_]+)_([^_]+)_([^_]+)\.csv$/);
        if (!match) return null;
        return { gpu: match[1], element: match[2], lattice: match[3], filename };
    }

    async function loadFileList() {
        // Try local files.json first (for local dev), then GitHub API
        try {
            const localResponse = await fetch('data/files.json');
            if (localResponse.ok) {
                const files = await localResponse.json();
                return files.map(parseFilename).filter(Boolean);
            }
        } catch (e) {}

        // Fall back to GitHub API (works on GitHub Pages)
        const { owner, repo } = getRepoInfo();
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/data`;
        try {
            const response = await fetch(apiUrl);
            const contents = await response.json();
            const csvFiles = contents
                .filter(f => f.name.startsWith('timing_data_') && f.name.endsWith('.csv'))
                .map(f => f.name);
            return csvFiles.map(parseFilename).filter(Boolean);
        } catch (e) {
            console.error('Failed to fetch file list:', e);
            return [];
        }
    }

    async function loadCSV(filename) {
        if (dataCache[filename]) return dataCache[filename];
        // Try relative path first (works on GitHub Pages), fall back to raw.githubusercontent.com
        let response = await fetch(`data/${filename}`);
        if (!response.ok) {
            const { owner, repo } = getRepoInfo();
            response = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/main/data/${filename}`);
        }
        const text = await response.text();
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',');
        const rows = lines.slice(1).map(line => {
            const values = line.split(',');
            const obj = {};
            headers.forEach((h, i) => obj[h.trim()] = values[i]?.trim());
            return obj;
        });
        // Normalize: handle both 'num_atoms' and 'atoms' columns
        const normalized = rows.map(r => ({
            model: r.model,
            num_atoms: parseInt(r.num_atoms || r.atoms),
            time: parseFloat(r.time),
            gpu: r.gpu
        })).filter(r => r.num_atoms > 8 && !isNaN(r.time) && r.time > 0);
        // Store GPU label from first row
        normalized.gpuLabel = rows[0]?.gpu || '';
        dataCache[filename] = normalized;
        return normalized;
    }

    function populateDropdowns() {
        const gpuSelect = document.getElementById('gpu');
        const systemSelect = document.getElementById('system');

        const gpus = [...new Set(availableFiles.map(f => f.gpu))].sort();
        const systems = [...new Set(availableFiles.map(f => `${f.element}_${f.lattice}`))].sort();

        gpuSelect.innerHTML = gpus.map(g =>
            `<option value="${g}"${g === 'H100' ? ' selected' : ''}>${g}</option>`
        ).join('');
        systemSelect.innerHTML = systems.map(s => {
            const [el, lat] = s.split('_');
            const selected = el === 'Si' ? ' selected' : '';
            return `<option value="${s}"${selected}>${el} (a=${lat})</option>`;
        }).join('');
    }

    function superscript(n) {
        const chars = { '0': '⁰', '1': '¹', '2': '²', '3': '³', '4': '⁴', '5': '⁵', '6': '⁶', '7': '⁷', '8': '⁸', '9': '⁹', '-': '⁻' };
        return String(n).split('').map(c => chars[c] || c).join('');
    }

    function formatLogTick(v) {
        const exp = Math.log10(v);
        // Show 10^n for powers of 10
        if (Number.isInteger(exp)) return `10${superscript(exp)}`;
        // Show smaller labels for 2 and 5 multiples (e.g., 20, 50, 200, 500)
        const mantissa = v / Math.pow(10, Math.floor(exp));
        if (Math.abs(mantissa - 2) < 0.01 || Math.abs(mantissa - 5) < 0.01) {
            return v >= 1000 ? `${v/1000}k` : v;
        }
        return '';
    }

    function formatNumberTick(v) {
        const exp = Math.log10(v);
        const mantissa = v / Math.pow(10, Math.floor(exp));
        // Show 1, 2, 5 multiples
        if (Math.abs(mantissa - 1) < 0.01 || Math.abs(mantissa - 2) < 0.01 || Math.abs(mantissa - 5) < 0.01) {
            if (v >= 1000000) return `${v/1000000}M`;
            if (v >= 1000) return `${v/1000}k`;
            return v;
        }
        return '';
    }

    function getYValue(time_ms, yAxisType) {
        const stepsPerDay = 86400000 / time_ms;
        const stepsPerSec = 1000 / time_ms;

        if (yAxisType === 'steps_million') {
            return stepsPerDay / 1e6;
        } else if (yAxisType.startsWith('ns_')) {
            const timestep = parseFloat(yAxisType.split('_')[1]);
            return stepsPerDay * timestep * 1e-6;
        } else if (yAxisType === 'steps_sec') {
            return stepsPerSec;
        } else if (yAxisType === 'ms_step') {
            return time_ms;
        }
        return stepsPerDay / 1e6;
    }

    function getYAxisLabel(yAxisType) {
        if (yAxisType === 'steps_million') return 'Million steps/day';
        if (yAxisType.startsWith('ns_')) return 'ns/day';
        if (yAxisType === 'steps_sec') return 'steps/s';
        if (yAxisType === 'ms_step') return 'ms/step';
        return 'Million steps/day';
    }

    function resetZoom() {
        if (chart) chart.resetZoom();
    }

    function isDarkMode() {
        return document.body.classList.contains('dark');
    }

    function getThemeColors() {
        const dark = isDarkMode();
        return {
            text: dark ? '#eee' : '#222',
            tick: dark ? '#ccc' : '#444',
            grid: dark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
            title: dark ? '#fff' : '#000',
            legend: dark ? '#ccc' : '#444',
            pointBorder: dark ? '#fff' : '#000'
        };
    }

    function toggleTheme() {
        document.body.classList.toggle('dark');
        document.body.classList.toggle('light');
        updateChart();
    }

    async function updateChart() {
        const gpu = document.getElementById('gpu').value;
        const compliance = document.getElementById('compliance').value;
        const system = document.getElementById('system').value;
        const yAxisType = document.getElementById('yaxis').value;
        const [element, lattice] = system.split('_');

        const file = availableFiles.find(f => f.gpu === gpu && f.element === element && f.lattice === lattice);
        if (!file) {
            if (chart) chart.destroy();
            chart = null;
            return;
        }

        const data = await loadCSV(file.filename);
        const gpuLabel = data.gpuLabel || gpu;
        const models = compliance === 'compliant'
            ? COMPLIANT_MODELS
            : [...COMPLIANT_MODELS, ...NON_COMPLIANT_MODELS];

        const datasets = [];
        models.forEach(model => {
            const modelData = data
                .filter(d => d.model === model)
                .sort((a, b) => a.num_atoms - b.num_atoms);
            if (modelData.length === 0) return;

            const colors = getThemeColors();
            datasets.push({
                label: model,
                data: modelData.map(d => ({ x: d.num_atoms, y: getYValue(d.time, yAxisType) })),
                borderColor: MODEL_COLORS[model] || '#999',
                backgroundColor: MODEL_COLORS[model] || '#999',
                pointStyle: 'rect',
                pointRadius: 4,
                pointBorderColor: colors.pointBorder,
                pointBorderWidth: 1,
                tension: 0
            });
        });

        if (chart) chart.destroy();

        const themeColors = getThemeColors();
        chart = new Chart(document.getElementById('chart'), {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'logarithmic',
                        title: { display: true, text: 'Number of atoms', font: { weight: 'bold', size: 13 }, color: themeColors.text },
                        ticks: {
                            callback: (v) => formatNumberTick(v),
                            maxRotation: 0,
                            color: themeColors.tick,
                            font: { weight: 'bold' },
                            autoSkip: false,
                            maxTicksLimit: 20
                        },
                        grid: {
                            color: (ctx) => {
                                const v = ctx.tick.value;
                                const exp = Math.log10(v);
                                return Number.isInteger(exp) ? themeColors.grid : 'transparent';
                            }
                        }
                    },
                    y: {
                        type: 'logarithmic',
                        title: { display: true, text: getYAxisLabel(yAxisType), font: { weight: 'bold', size: 13 }, color: themeColors.text },
                        afterBuildTicks: (axis) => {
                            // Ensure ticks at all powers of 10
                            const ticks = axis.ticks;
                            if (ticks.length < 2) return;
                            const min = Math.floor(Math.log10(ticks[0].value));
                            const max = Math.ceil(Math.log10(ticks[ticks.length - 1].value));
                            const newTicks = [];
                            for (let exp = min; exp <= max; exp++) {
                                newTicks.push({ value: Math.pow(10, exp) });
                                // Add 2 and 5 multiples for labels
                                if (exp < max) {
                                    newTicks.push({ value: 2 * Math.pow(10, exp) });
                                    newTicks.push({ value: 5 * Math.pow(10, exp) });
                                }
                            }
                            axis.ticks = newTicks;
                        },
                        ticks: {
                            callback: (v) => formatNumberTick(v),
                            color: themeColors.tick,
                            font: { weight: 'bold' },
                            autoSkip: false
                        },
                        grid: {
                            color: (ctx) => {
                                const v = ctx.tick.value;
                                const exp = Math.log10(v);
                                return Math.abs(exp - Math.round(exp)) < 0.01 ? themeColors.grid : 'transparent';
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: `Matbench ${compliance}, ${element} (a=${lattice}) - ${gpuLabel}`,
                        font: { size: 14 },
                        color: themeColors.title
                    },
                    legend: { position: 'right', labels: { font: { size: 11 }, boxWidth: 12, color: themeColors.legend } },
                    zoom: {
                        pan: { enabled: true, mode: 'xy' },
                        zoom: {
                            wheel: { enabled: true, speed: 0.05 },
                            pinch: { enabled: true },
                            drag: { enabled: true, backgroundColor: 'rgba(0,0,255,0.1)' },
                            mode: 'xy'
                        }
                    }
                }
            }
        });
    }

    async function init() {
        availableFiles = await loadFileList();
        populateDropdowns();
        document.getElementById('gpu').addEventListener('change', updateChart);
        document.getElementById('compliance').addEventListener('change', updateChart);
        document.getElementById('system').addEventListener('change', updateChart);
        document.getElementById('yaxis').addEventListener('change', updateChart);
        updateChart();
    }

    init();
    </script>
</body>
</html>
